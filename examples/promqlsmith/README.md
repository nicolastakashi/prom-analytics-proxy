# PromQLSmith Query Generator

A load testing and fuzzing tool for Prometheus using PromQLSmith to generate random valid PromQL queries.

## Features

- **Concurrent query execution** - Run range and instant queries in parallel
- **Error categorization** - Track different types of errors (bad_data, many-to-many, regex, timeouts)
- **Panic recovery** - Gracefully handle panics from query generation
- **Configurable** - Control iterations, workers, and logging via command-line flags
- **Statistics tracking** - Thread-safe counters using atomic operations
- **Performance metrics** - Track queries per second and success rates

## Usage

### Basic Usage

```bash
# Run for 5 minutes (default)
go run main.go

# Run for 10 minutes
go run main.go -duration 10m

# Run for 30 seconds
go run main.go -duration 30s
```

### Configuration Options

```bash
# Run with custom Prometheus URL
go run main.go -url http://localhost:9090

# Run for a specific duration
go run main.go -duration 10m

# Run for specific iterations instead of time
go run main.go -duration 0s -iterations 5000

# Run only range queries (1 worker)
go run main.go -workers 1

# Enable detailed error logging
go run main.go -log-errors

# Custom progress reporting (every 30 seconds)
go run main.go -progress-interval 30s

# Combined example
go run main.go -url http://localhost:9091 -duration 2m -workers 2 -log-errors -progress-interval 15s
```

### Flags

| Flag | Default | Description |
|------|---------|-------------|
| `-url` | `http://localhost:9091` | Prometheus URL |
| `-duration` | `5m` | Run duration (e.g., 30s, 5m, 1h). Takes precedence over iterations. |
| `-iterations` | `0` | Number of iterations per query type (0 = unlimited with duration) |
| `-workers` | `2` | Number of concurrent workers (1=range only, 2=range+instant) |
| `-progress-interval` | `10s` | Progress reporting interval (e.g., 5s, 30s, 1m) |
| `-log-errors` | `false` | Log error details to stderr |

## Output Example

### Duration-based execution (default)

```text
Fetching series from http://localhost:9091...
Found 324 series

Running for 5m0s (until 15:45:30)
Workers: 2
Progress interval: 10s

[Range] 1523 queries, 4m50s remaining - Total: 2987, Success: 2601 (87.1%), Errors: 385 (12.9%), Panics: 1 (0.0%)
[Instant] 1542 queries, 4m50s remaining - Total: 2987, Success: 2601 (87.1%), Errors: 385 (12.9%), Panics: 1 (0.0%)
...

=== Final Results ===
Combined - Total: 43892, Success: 38214 (87.1%), Errors: 5676 (12.9%), Panics: 2 (0.0%)

=== Detailed Error Breakdown ===
Bad Data (resolution/invalid): 5324
Many-to-Many Matching: 315
Regex Errors: 12
Timeouts: 18
Other Errors: 7

Total queries executed: 43892
Elapsed time: 5m0s
Queries per second: 146.31
```

### Iteration-based execution

```bash
go run main.go -duration 0s -iterations 10000
```

```text
Fetching series from http://localhost:9091...
Found 324 series

Running 10000 iterations per worker
Workers: 2
Progress interval: 10s

[Range] Progress 5000/10000 - Total: 9823, Success: 8547 (87.0%), Errors: 1275 (13.0%), Panics: 1 (0.0%)
[Instant] Progress 5234/10000 - Total: 9823, Success: 8547 (87.0%), Errors: 1275 (13.0%), Panics: 1 (0.0%)
...

=== Final Results ===
Combined - Total: 20000, Success: 17396 (87.0%), Errors: 2603 (13.0%), Panics: 1 (0.0%)

=== Detailed Error Breakdown ===
Bad Data (resolution/invalid): 2450
Many-to-Many Matching: 143
Regex Errors: 5
Timeouts: 3
Other Errors: 2

Total queries executed: 20000
Elapsed time: 2m15s
Queries per second: 148.15
```

## Error Categories

The tool categorizes errors into:

- **Bad Data**: Resolution limits, invalid data ranges
- **Many-to-Many Matching**: PromQL matching label conflicts
- **Regex Errors**: Invalid regex patterns (usually from PromQLSmith generation)
- **Timeouts**: Query execution timeouts
- **Other**: All other error types

## Panic Resilience

**The tool is designed to never stop running due to panics.** Each query execution is wrapped in a panic recovery handler that:

1. Catches any panic that occurs during query generation or execution
2. Records it in the panic counter
3. Optionally logs the panic details (with `-log-errors`)
4. **Continues to the next iteration without interrupting execution**

This means you can safely run load tests for extended periods without worrying about crashes from:

- Invalid regex patterns generated by PromQLSmith
- Unexpected query parsing errors
- Any other runtime panics

The tool will keep running until:

- The specified duration expires (`-duration`)
- The iteration count is reached (`-iterations`)
- You manually interrupt it (Ctrl+C)

## Known Issues

### PromQLSmith Regex Panics

Occasionally, PromQLSmith generates invalid regex patterns like `**` (nested repetition operator), which causes panics. These are caught and tracked in the panic counter. This is a known issue in the upstream PromQLSmith library.

**Impact:** None - panics are recovered and execution continues.

### High Error Rate

The error rate of ~13% is expected due to:

- Resolution limits (11,000 points per timeseries)
- Many-to-many matching issues in generated queries
- Edge cases in PromQL syntax that are valid but not supported by all Prometheus versions

**Impact:** This is normal behavior for fuzzing/load testing and helps identify edge cases.

## Integration with Docker Compose

This tool is designed to work with the example Docker Compose setup:

```bash
cd ../
docker compose up -d
cd promqlsmith
go run main.go
```

## Dependencies

- `github.com/cortexproject/promqlsmith` - Query generation
- `github.com/prometheus/client_golang` - Prometheus API client
- `github.com/prometheus/prometheus` - PromQL parser and labels

## Architecture

The tool uses:

- **Atomic operations** for thread-safe statistics tracking
- **Goroutines** for concurrent query execution
- **Panic recovery** at the iteration level to prevent crashes
- **Context propagation** for timeout handling
